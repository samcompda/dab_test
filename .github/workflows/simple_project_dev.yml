name: 'Deploy simple_project to DEV'
concurrency: 1
on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['**/*.yml', '**/*.py']

jobs:
  deploy:
    name: 'Deploy bundle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      
      # NEW: GCP authentication and secret retrieval
      - name: Authenticate to GCP
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Get Databricks host from GCP
        id: get-db-host
        uses: 'google-github-actions/get-secretmanager-secrets@v1'
        with:
          secrets: |-
            projects/metal-cascade-460422-t6/secrets/gcp_dev_databricks_host:latest
      
      - run: databricks bundle deploy
        working-directory: .
        env:
          DATABRICKS_CLIENT_ID: ${{ secrets.DEV_DATABRICKS_SP_CLIENT }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DEV_DATABRICKS_SP_TOKEN }}
          DATABRICKS_HOST: ${{ steps.get-db-host.outputs.gcp_dev_databricks_host }}  # Updated
          DATABRICKS_BUNDLE_ENV: dev

  pipeline_update:
    name: 'Run pipeline update'
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - uses: actions/checkout@v3
      - uses: databricks/setup-cli@main
      
      # NEW: Same GCP steps as above
      - name: Authenticate to GCP
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Get Databricks host from GCP
        id: get-db-host
        uses: 'google-github-actions/get-secretmanager-secrets@v1'
        with:
          secrets: |-
            projects/metal-cascade-460422-t6/secrets/gcp_dev_databricks_host:latest
      
      - run: databricks bundle run my-job --refresh-all
        working-directory: .
        env:
          DATABRICKS_CLIENT_ID: ${{ secrets.DEV_DATABRICKS_SP_CLIENT }}
          DATABRICKS_CLIENT_SECRET: ${{ secrets.DEV_DATABRICKS_SP_TOKEN }}
          DATABRICKS_HOST: ${{ steps.get-db-host.outputs.gcp_dev_databricks_host }}  # Updated
          DATABRICKS_BUNDLE_ENV: dev
